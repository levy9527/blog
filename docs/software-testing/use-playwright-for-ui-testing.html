<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>下一代 E2E 测试工具 Playwright | Levy&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="https://avatars3.githubusercontent.com/u/39977793?s=200&amp;v=4">
    <style>img { display: block; }</style>
    <meta name="description" content="think, speak, practice, create">
    
    <link rel="preload" href="/assets/css/0.styles.e8e4f3a3.css" as="style"><link rel="preload" href="/assets/js/app.c8203740.js" as="script"><link rel="preload" href="/assets/js/2.733019b2.js" as="script"><link rel="preload" href="/assets/js/29.646b11f4.js" as="script"><link rel="prefetch" href="/assets/js/10.14904d10.js"><link rel="prefetch" href="/assets/js/11.26032aa1.js"><link rel="prefetch" href="/assets/js/12.f20db416.js"><link rel="prefetch" href="/assets/js/13.e30d1156.js"><link rel="prefetch" href="/assets/js/14.4422304f.js"><link rel="prefetch" href="/assets/js/15.cf41677c.js"><link rel="prefetch" href="/assets/js/16.951aaf29.js"><link rel="prefetch" href="/assets/js/17.cfc37bf2.js"><link rel="prefetch" href="/assets/js/18.87578200.js"><link rel="prefetch" href="/assets/js/19.975ac5a3.js"><link rel="prefetch" href="/assets/js/20.080bd3fa.js"><link rel="prefetch" href="/assets/js/21.d4037afd.js"><link rel="prefetch" href="/assets/js/22.2c869f9c.js"><link rel="prefetch" href="/assets/js/23.b2736c55.js"><link rel="prefetch" href="/assets/js/24.32b31524.js"><link rel="prefetch" href="/assets/js/25.bc98df8a.js"><link rel="prefetch" href="/assets/js/26.2c50b804.js"><link rel="prefetch" href="/assets/js/27.f2ac6b2b.js"><link rel="prefetch" href="/assets/js/28.e7640c18.js"><link rel="prefetch" href="/assets/js/3.893008e2.js"><link rel="prefetch" href="/assets/js/30.02309f92.js"><link rel="prefetch" href="/assets/js/31.8cedf862.js"><link rel="prefetch" href="/assets/js/4.d12742be.js"><link rel="prefetch" href="/assets/js/5.216cae74.js"><link rel="prefetch" href="/assets/js/6.1708a684.js"><link rel="prefetch" href="/assets/js/7.64a18af6.js"><link rel="prefetch" href="/assets/js/8.eeb6b0e0.js"><link rel="prefetch" href="/assets/js/9.66b54d96.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8e4f3a3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Levy's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/levy9527/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/levy9527/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>英语学习</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/english/everyone-can-learn-english-1-overview.html" class="sidebar-link">人人都能学会的英语1：开篇</a></li><li><a href="/docs/english/everyone-can-learn-english-2-pronunciation.html" class="sidebar-link">人人都能学会的英语2：音标</a></li><li><a href="/docs/english/everyone-can-learn-english-3-words.html" class="sidebar-link">人人都能学会的英语3：单词</a></li><li><a href="/docs/english/everyone-can-learn-english-4-listening-and-speaking.html" class="sidebar-link">人人都能学会的英语4：听说</a></li><li><a href="/docs/english/everyone-can-learn-english-5-reading-and-writing.html" class="sidebar-link">人人都能学会的英语5：读写</a></li><li><a href="/docs/english/how-to-self-evaluate-english-level.html" class="sidebar-link">英文能力评测手把手教学</a></li><li><a href="/docs/english/learning-7000-words-task-completed.html" class="sidebar-link">完成刷7k单词任务</a></li><li><a href="/docs/english/let-chatgpt-be-your-foreign-language-teacher.html" class="sidebar-link">让 ChatGPT 成为你的外语私教</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端技术</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/frontend/old-articles.html" class="sidebar-link">旧文章精选</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Git相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/git/git-best-pratices.html" class="sidebar-link">Git最佳实践</a></li><li><a href="/docs/git/git-definitive-guide-to-merge-code.html" class="sidebar-link">Git代码合并指南</a></li><li><a href="/docs/git/git-useful-commands.html" class="sidebar-link">Git常用命令</a></li><li><a href="/docs/git/gitlab-ci.html" class="sidebar-link">Gitlab CI</a></li><li><a href="/docs/git/rethinking-git-flow.html" class="sidebar-link">再论Git Flow</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>软件测试</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/software-testing/use-RestAssured-for-api-testing.html" class="sidebar-link">使用 RestAssured 进行 API 测试</a></li><li><a href="/docs/software-testing/use-cypress-for-e2e-testing.html" class="sidebar-link">使用 Cypress 进行端对端测试</a></li><li><a href="/docs/software-testing/use-playwright-for-ui-testing.html" aria-current="page" class="active sidebar-link">下一代 E2E 测试工具 Playwright</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software-testing/use-playwright-for-ui-testing.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/docs/software-testing/use-playwright-for-ui-testing.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/docs/software-testing/use-playwright-for-ui-testing.html#使用" class="sidebar-link">使用</a></li><li class="sidebar-sub-header"><a href="/docs/software-testing/use-playwright-for-ui-testing.html#常见场景与解决方案" class="sidebar-link">常见场景与解决方案</a></li><li class="sidebar-sub-header"><a href="/docs/software-testing/use-playwright-for-ui-testing.html#持续集成" class="sidebar-link">持续集成</a></li><li class="sidebar-sub-header"><a href="/docs/software-testing/use-playwright-for-ui-testing.html#其他" class="sidebar-link">其他</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>必备工具</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/tools/how-to-connect-to-internet.html" class="sidebar-link">科学上网</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="下一代-e2e-测试工具-playwright"><a href="#下一代-e2e-测试工具-playwright" class="header-anchor">#</a> 下一代 E2E 测试工具 Playwright</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>Playwright 是微软于 2020 年发布的一款 E2E testing 工具，跟社区成熟的 Cypress 相比，稍显年轻。然而 Playwright 的主要优势有：</p> <ol><li>支持多语言：Node.js、Java、Python，也即它并非是前端工程师专属的工具</li> <li>开箱即用的代码生成功能（Cypress 现在也支持，不过要修改配置或安装插件）</li></ol> <p>另外，Playwright 的安装没什么门槛，不像 Cypress 可能需要黑魔法。</p> <p>综上所述，笔者认为 Playwright 是值得在研发过程中引入的一款测试工具，它可以帮助研发、测试团队较平滑地走上自动化测试之路。它适用的典型场景之一，就是做回归测试——测试人员再也不用在界面上使用鼠标进行“点点点”，解放双手，提高测试效率。</p> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> create playwright
</code></pre></div><p>根据命令提示，输入如下：
<img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683274667037.png" alt="image.png">
默认会下载所有浏览器，如果没有浏览器兼容性测试的需求，推荐如上图所示，手动安装一个浏览器。</p> <p>以安装 chromium 为例，相应操作步骤如下：</p> <ol><li>修改配置</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> playwright.config.ts
</code></pre></div><p>注释掉以下内容：
<img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683274759403.png" alt="image.png"></p> <ol start="2"><li>安装浏览器</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> playwright <span class="token function">install</span> --with-deps chromium
</code></pre></div><p>等待一段时间即可，如果失败，请重试。
<img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683274769748.png" alt="image.png"></p> <p>推荐再安装 <a href="https://marketplace.visualstudio.com/items?itemName=ms-playwright.playwright" target="_blank" rel="noopener noreferrer">VS Code 插件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，获取更好的使用体验。</p> <h2 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h2> <h3 id="代码生成"><a href="#代码生成" class="header-anchor">#</a> 代码生成</h3> <p>虽然可以参考 <code>example.spec.ts</code>去编写测试用例，但这不是 Playwright 独特之处。Playwright 最引入注目的，是代码生成功能。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> playwright codegen
</code></pre></div><p>上述命令会打开两个浏览器窗口：</p> <ol><li>一个是普通的浏览器界面</li> <li>另一个是代码生成界面，在前一个窗口进行的任何操作，都会生成相应的代码</li></ol> <p><img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683275050705.png" alt="image.png">
虽然默认生成代码是 Javascript，但可以选择切换语言：
<img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683275136008.png" alt="image.png">
注意到可以生成 Pytest 的代码，对测试工程师来说，简直是福音。这也提示我们，Playwright 既可以由前端研发来使用，也可以由测试人员来使用，并不限制使用者的职业身份。</p> <p>点击&quot;Copy&quot;按钮
<img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683276292010.png" alt="image.png">
然后打开代码编辑器，把代码复制进去即可。</p> <p>点击&quot;Clear&quot;按钮，
<img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683277483800.png" alt="image.png">
可以清空本次操作生成的代码，从而开始进行下一次操作的代码生成。</p> <p>如果是使用 VS Code 插件，点击&quot;Record new&quot;即可。
<img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683277490131.png" alt="image.png"></p> <h3 id="修改代码"><a href="#修改代码" class="header-anchor">#</a> 修改代码</h3> <p>生成的代码，最好还是检查一下，也许需要去掉一些多余的操作记录。
如下面的代码，<code>Tab</code>的操作只是人工操作时为了方便而进行的按键，对机器而言，是多余的，应该去掉。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> page <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">'http://172.16.202.6:3000/#/login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">getByRole</span><span class="token punctuation">(</span><span class="token string">'textbox'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">getByRole</span><span class="token punctuation">(</span><span class="token string">'textbox'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//await page.getByRole('textbox').first().press('Tab');</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">getByRole</span><span class="token punctuation">(</span><span class="token string">'textbox'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nth</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//await page.getByRole('textbox').nth(1).press('Tab');</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">locator</span><span class="token punctuation">(</span><span class="token string">'input[type=&quot;password&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">getByRole</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'登录'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>如果想基于现在的测试代码，继续生成新的代码，可以使用 VS Code：</p> <ul><li>把光标放到测试用例的最后一行</li> <li>点击&quot;Record at cursor&quot;，即可继续录制</li></ul> <p><img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683277555357.png" alt="image.png"></p> <h3 id="执行用例"><a href="#执行用例" class="header-anchor">#</a> 执行用例</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> playwright <span class="token builtin class-name">test</span>
</code></pre></div><p><img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683277566741.png" alt="image.png">
如果用例失败了，想查看到底哪里错了，可以用以下命令显示浏览器，查看用例执行过程：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">yarn</span> playwright <span class="token builtin class-name">test</span> <span class="token parameter variable">--headed</span>
</code></pre></div><p>如果是使用 VS Code，直接点击运行用例即可。
<img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683277575650.png" alt="image.png">
勾选左下角的&quot;Show broswer&quot;，即可显示浏览器。
<img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683277598218.png" alt="image.png"></p> <h3 id="调试用例"><a href="#调试用例" class="header-anchor">#</a> 调试用例</h3> <p>对于失败的用例，如何 debug呢？添加 --debug 参数即可。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> playwright <span class="token builtin class-name">test</span> <span class="token parameter variable">--debug</span>
</code></pre></div><p>点击&quot;Step over&quot; 即可执行下一行代码。
<img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683277605265.png" alt="image.png"></p> <p>如果是使用 VS Code，找到相应的用例，右键出现&quot;Debug Test&quot;，点击即可。
<img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683277678957.png" alt="image.png"></p> <h3 id="查看报告"><a href="#查看报告" class="header-anchor">#</a> 查看报告</h3> <p>在执行完用例后，本地会生成目录 <code>playwright-report</code>，可以通过以下命令查看测试报告</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> playwright show-report
</code></pre></div><p><img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683277713874.png" alt="image.png"></p> <h2 id="常见场景与解决方案"><a href="#常见场景与解决方案" class="header-anchor">#</a> 常见场景与解决方案</h2> <h3 id="应用登录"><a href="#应用登录" class="header-anchor">#</a> 应用登录</h3> <p>下面给出一个自动登录、并保存用户数据的解决方案。</p> <p>先创建文件夹，并让 git 忽略它</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> playwright/auth
<span class="token builtin class-name">echo</span> <span class="token string">&quot;playwright/auth&quot;</span> <span class="token operator">&gt;&gt;</span> .gitignore
</code></pre></div><p>创建 login.ts</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> chromium<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> FullConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@playwright/test'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">config</span><span class="token operator">:</span> FullConfig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setting up'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> storageState <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">.</span>projects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>use
  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> chromium<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 这里执行登录操作</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">'http://localhost:3000/login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">getByRole</span><span class="token punctuation">(</span><span class="token string">'textbox'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">locator</span><span class="token punctuation">(</span><span class="token string">'input[type=&quot;password&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'pass'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">getByRole</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'登录'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 等待成功</span>
  <span class="token keyword">await</span> <span class="token function">expect</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getByRole</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'登录'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBeVisible</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// End of authentication steps.</span>

  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">storageState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> storageState <span class="token keyword">as</span> string <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> login
</code></pre></div><p>修改 playwright.config.ts</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">globalSetup</span><span class="token operator">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./login'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 添加这一行</span>
  <span class="token literal-property property">projects</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'chromium'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
        <span class="token operator">...</span>devices<span class="token punctuation">[</span><span class="token string">'Desktop Chrome'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">storageState</span><span class="token operator">:</span> <span class="token string">'playwright/auth/user.json'</span><span class="token punctuation">,</span> <span class="token comment">// 添加这一行</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="本地测试与线上ci"><a href="#本地测试与线上ci" class="header-anchor">#</a> 本地测试与线上CI</h3> <p>使用环境变量配置 baseURL 即可。</p> <p>修改 playwright.config.ts</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">baseURL</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PLAYWRIGHT_BASE_URL</span> <span class="token operator">?</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PLAYWRIGHT_BASE_URL</span> <span class="token operator">:</span> <span class="token string">'http://127.0.0.1:3000'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="超时时间"><a href="#超时时间" class="header-anchor">#</a> 超时时间</h3> <p>默认的超时时间不太够用，建议修改 playwright.config.ts:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// 单个用例的超时时间</span>
  <span class="token literal-property property">expect</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// expect 语句的超时时间</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>同时要注意拆分用例，没有依赖关系的用例建议拆分开来，避免用例执行时间过长超时。</p> <h3 id="元素选择"><a href="#元素选择" class="header-anchor">#</a> 元素选择</h3> <p>人们对元素选择的第一反应是使用 CSS 或 XPath，但 Playwright 并不鼓励这样使用，因为这些选择器容易改变。较为好的办法是，为测试元素添加专门的属性 testid，如下所示：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">data-testid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>my-div<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>然后通过下列方式进行选择：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">getByTestId</span><span class="token punctuation">(</span><span class="token string">'my-div'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>当然，这种方式会对源代码有侵入。更为折衷的方式是，优先使用下列<a href="https://playwright.dev/docs/locators#locate-by-role" target="_blank" rel="noopener noreferrer">官方推荐的方法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>进行元素选择，最后再使用业务 class，
<img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683277746417.png" alt="image.png"></p> <p>这里值得一提的是，业务class是针对 Tailwind CSS 这种“解构主义”的纯样式class而言的。你会发现，如果全是 Tailwind 的class，没有业务样式，E2E测试代码很不好写。</p> <p>如果是使用 VS Code，有辅助办法：</p> <ol><li>点击“Pick locator”
<img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683421157907.png" alt="image.png"></li> <li>切换到浏览器界面，点击目标元素</li> <li>切回 VS Code，即可看到相应的元素选择代码
<img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683421163861.png" alt="image.png"></li></ol> <h3 id="声明断言-检查元素是否存在"><a href="#声明断言-检查元素是否存在" class="header-anchor">#</a> 声明断言 &amp;&amp; 检查元素是否存在</h3> <p>生成的代码是没有断言的，因此，很有可能页面报错了，用例执行报告仍然显示成功。为避免这种情况，每个用例至少要有一句断言。</p> <p>常用的断言是，检查某一元素是否存在：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> <span class="token function">expect</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">locator</span><span class="token punctuation">(</span><span class="token string">'.selected-item'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 1 代表相应的元素数量</span>
</code></pre></div><p>当然也可以用以下方法，这取决于元素是否可见（元素存在，未必可见）。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> <span class="token function">expect</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">locator</span><span class="token punctuation">(</span><span class="token string">'.selected-item'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeVisible</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
</code></pre></div><p>注意，Node.js 才可以在 locator 里写 CSS 选择器，如果是 Python, 需要这样写：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">await</span> expect<span class="token punctuation">(</span>page<span class="token punctuation">.</span>query_selector<span class="token punctuation">(</span><span class="token string">'.selected-item'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toBeVisible<span class="token punctuation">(</span><span class="token punctuation">)</span> 
</code></pre></div><p>更多断言写法，参考<a href="https://playwright.dev/docs/writing-tests#assertions" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h3 id="获取第n个元素"><a href="#获取第n个元素" class="header-anchor">#</a> 获取第n个元素</h3> <p>通过定位器得到的元素可能不止一个，可以使用以下代码获得具体某一个元素：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>page<span class="token punctuation">.</span><span class="token function">locator</span><span class="token punctuation">(</span><span class="token string">'.my-class'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nth</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// n 从 0 开始算起</span>
</code></pre></div><h3 id="遍历元素"><a href="#遍历元素" class="header-anchor">#</a> 遍历元素</h3> <p>使用定位器后，调用<code>.all()</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> row <span class="token keyword">of</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">getByRole</span><span class="token punctuation">(</span><span class="token string">'listitem'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> row<span class="token punctuation">.</span><span class="token function">textContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="获取元素属性"><a href="#获取元素属性" class="header-anchor">#</a> 获取元素属性</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="判断子元素数量"><a href="#判断子元素数量" class="header-anchor">#</a> 判断子元素数量</h3> <p>使用 <code>$</code> 及 <code>$$</code> <a href="https://playwright.dev/docs/api/class-elementhandle#element-handle-query-selector" target="_blank" rel="noopener noreferrer">元素选择器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> hiddenColumns <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.table-section .hidden-columns'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword">await</span> hiddenColumns<span class="token punctuation">.</span><span class="token function">$$</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveLength</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="鼠标悬浮"><a href="#鼠标悬浮" class="header-anchor">#</a> 鼠标悬浮</h3> <p>有些元素是在鼠标悬浮时才显示或创建的，可以使用以下代码</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">locator</span><span class="token punctuation">(</span><span class="token string">'.my-class'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hover</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 模拟鼠标悬浮事件</span>
<span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">locator</span><span class="token punctuation">(</span><span class="token string">'.my-class .hover-element'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 点击悬浮后显示的元素</span>
</code></pre></div><p>这里有个问题，自己怎么知道悬浮后显示的元素是否正确地定位到了呢？可以通过下面的小技巧：</p> <ol><li>切换到 codegen 打开的浏览器页面</li> <li>打开网页控制台（按F12)</li> <li>鼠标悬浮在目标元素上面，然后右键，如下图所示</li></ol> <p><img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683277759344.png" alt="image.png"></p> <ol start="4"><li>点击控制台内部，则此时元素不会丢失 hover 状态，如下图所示</li></ol> <p><img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683277780882.png" alt="image.png"></p> <ol start="5"><li>切换到 VS Code</li></ol> <p><img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683277793308.png" alt="image.png"></p> <h3 id="操作剪贴板"><a href="#操作剪贴板" class="header-anchor">#</a> 操作剪贴板</h3> <p>读写剪贴板需要设置权限，下面给出一个判断是否成功从剪贴板获取特定文本的测试用例：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'clipboard'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>page<span class="token punctuation">,</span> context<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span><span class="token function">grantPermissions</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'clipboard-read'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">'www.my-home.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">getByRole</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Copy'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> copyText <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> navigator<span class="token punctuation">.</span>clipboard<span class="token punctuation">.</span><span class="token function">readText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">expect</span><span class="token punctuation">(</span>copyText<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'text from copy!'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="持续集成"><a href="#持续集成" class="header-anchor">#</a> 持续集成</h2> <p>以 Gitlab CI 为例，说明 Playwright 如何集成进 CI 流水线中。其他方式如 Jenkins，请<a href="https://playwright.dev/docs/ci#jenkins" target="_blank" rel="noopener noreferrer">参考文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>首先确保已安装 Gitlab Runner 并成功注册，具体操作可以参考<a href="https://levy.vip/docs/git/gitlab-ci.html#%E5%AE%89%E8%A3%85gitlab-runner" target="_blank" rel="noopener noreferrer">安装文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>端对端的测试耗时较长，并且对环境的稳定性有要求，作为回归测试的实践时，一般倾向于借助定时任务跑测试用例。</p> <p>新建调度：
<img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683436020492.png" alt="image.png">
设置调度时间及环境变量：</p> <ul><li>每 6 小时跑一次</li> <li>e2e 环境变量的值为 true</li></ul> <p><img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683436027996.png" alt="image.png"></p> <p>现在可以开始编写 .gitlab-ci.yml，下面只给出测试相关的配置。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">image</span><span class="token punctuation">:</span> node<span class="token punctuation">:</span>lts <span class="token comment"># it doesn't matter because playwright will use another image</span>

<span class="token key atrule">cache</span><span class="token punctuation">:</span>
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> node_modules/

<span class="token key atrule">stages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> test

<span class="token key atrule">e2e</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> test
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> your<span class="token punctuation">-</span>runner<span class="token punctuation">-</span>name
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">if</span><span class="token punctuation">:</span> <span class="token string">'$CI_PIPELINE_SOURCE == &quot;schedule&quot; &amp;&amp; $e2e'</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mcr.microsoft.com/playwright<span class="token punctuation">:</span>v1.33.0<span class="token punctuation">-</span>jammy
    <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'/bin/bash'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'ln -snf /bin/bash /bin/sh &amp;&amp; /bin/bash -c $0'</span> <span class="token punctuation">]</span>
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> yarn <span class="token punctuation">-</span><span class="token punctuation">-</span>frozen<span class="token punctuation">-</span>lockfile <span class="token punctuation">-</span><span class="token punctuation">-</span>ignore<span class="token punctuation">-</span>engines
    <span class="token punctuation">-</span> yarn playwright install <span class="token punctuation">-</span><span class="token punctuation">-</span>with<span class="token punctuation">-</span>deps chromium
    <span class="token punctuation">-</span> yarn playwright test
</code></pre></div><p>注意点：</p> <ol><li>entrypoint 解决的是 <a href="https://gitlab.com/gitlab-org/gitlab-runner/-/issues/27614" target="_blank" rel="noopener noreferrer">shell not found<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 问题</li> <li>--ignore-engines 可以在不修改源码的情况下避免安装失败</li> <li>只有定时调度才会触发该任务的执行</li></ol> <p>再修改 Gitlab Runner 的配置，解决<a href="https://github.com/nodejs/help/issues/1754#issuecomment-1260462271" target="_blank" rel="noopener noreferrer">yarn命令无法运行<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的问题：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /srv/gitlab-runner/config/config.toml
</code></pre></div><p>根据 token 找到对应的 Runner 配置，按照下图所示，把红框处的值设置成 <code>true</code> <img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683277800200.png" alt="image.png">
config.toml 里面可能会有多个 Runner 配置，如何找到要修改哪一个呢？
可以在项目界面，根据下图所示的 token（w8exPBfA） 去查找。
<img src="https://raw.gitmirror.com/levy9527/image-holder/main/docs/software-test/1683277808112.png" alt="image.png"></p> <p>修改完后，重启 Gitlab Runner</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> restart gitlab-runner 
</code></pre></div><p>最后，使用 Chromium 可能会出现内存超出限制的问题，需要对 Docker 设置 --ipc=host，配置 .gitlab-ci.yml 如下：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>dind
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;--insecure-registry&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;registry.example.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--storage-driver=overlay2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--iptables=false&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--ip-masq=false&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--ipv6=false&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--fixed-cidr=10.0.0.0/8&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--fixed-cidr-v6=fc00::/7&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-H&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tcp://0.0.0.0:2375&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-H&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;unix:///var/run/docker.sock&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">ipc</span><span class="token punctuation">:</span> host
</code></pre></div><h2 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h2> <h3 id="setup-py-bdist-wheel-did-not-run-successfully"><a href="#setup-py-bdist-wheel-did-not-run-successfully" class="header-anchor">#</a> <strong>setup.py bdist_wheel did not run successfully</strong></h3> <p>Python安装时，可能会再现此错误。解决方案如下：</p> <div class="language-python extra-class"><pre class="language-python"><code>pip install cmake
<span class="token comment"># or </span>
pip3 install cmake

</code></pre></div><p>之后，再安装</p> <div class="language-python extra-class"><pre class="language-python"><code>pip install wheel setuptools <span class="token operator">-</span><span class="token operator">-</span>upgrade
<span class="token comment"># or</span>
pip3 install wheel setuptools <span class="token operator">-</span><span class="token operator">-</span>upgrade
</code></pre></div><p>最后，重新安装Playwright即可</p> <div class="language-python extra-class"><pre class="language-python"><code>pip install playwright
<span class="token comment"># or</span>
pip3 install playwright

</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>playwright install <span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">with</span><span class="token operator">-</span>deps chromium
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/software-testing/use-cypress-for-e2e-testing.html" class="prev">
        使用 Cypress 进行端对端测试
      </a></span> <span class="next"><a href="/docs/tools/how-to-connect-to-internet.html">
        科学上网
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c8203740.js" defer></script><script src="/assets/js/2.733019b2.js" defer></script><script src="/assets/js/29.646b11f4.js" defer></script>
  </body>
</html>
