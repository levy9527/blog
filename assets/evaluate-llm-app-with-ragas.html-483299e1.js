import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as a,f as t}from"./app-9028142a.js";const e={},p=t(`<h1 id="使用ragas评估llm应用" tabindex="-1"><a class="header-anchor" href="#使用ragas评估llm应用" aria-hidden="true">#</a> 使用Ragas评估LLM应用</h1><h2 id="说明" tabindex="-1"><a class="header-anchor" href="#说明" aria-hidden="true">#</a> 说明</h2><p>对于已知问题有正确答案的场景，适合使用 ragas 的 faithfulness 指标对 GenAI 应用响应结果进行评估，方便进行回归测试。</p><p>注意：本文提到的方法，只适用于对已知问题的评估。对于线上运行时，用户提的随机的、不在测试集范围内的问题，不适合用此方法评估。</p><h2 id="安装" tabindex="-1"><a class="header-anchor" href="#安装" aria-hidden="true">#</a> 安装</h2><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>pip install ragas
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="数据说明" tabindex="-1"><a class="header-anchor" href="#数据说明" aria-hidden="true">#</a> 数据说明</h2><p>对以下数据进行评估。</p><p>事实：Einstein was born in 1879 in Germany.<br> 提问：</p><ol><li>When did Einstein born?</li><li>Where did Einstein born?</li></ol><p>正确答案：</p><ol><li>Einstein was born in 1879.</li><li>Einstein was born in Germany.</li></ol><h2 id="正确性❌" tabindex="-1"><a class="header-anchor" href="#正确性❌" aria-hidden="true">#</a> 正确性❌</h2><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv
load_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">from</span> datasets <span class="token keyword">import</span> Dataset 
<span class="token keyword">from</span> ragas<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> answer_correctness
<span class="token keyword">from</span> ragas <span class="token keyword">import</span> evaluate

data_samples <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&#39;question&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">&#39;When did Einstein born?&#39;</span><span class="token punctuation">,</span> 
        <span class="token string">&#39;Where did Einstein born?&#39;</span><span class="token punctuation">,</span> 
                 <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&#39;answer&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
               <span class="token string">&#39;Einstein was born in 1879.&#39;</span><span class="token punctuation">,</span>
               <span class="token string">&#39;Einstein was born in Germany.&#39;</span><span class="token punctuation">,</span>
               <span class="token comment">#&#39;Einstein was born in 1879 in Germany.&#39;</span>
               <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&#39;ground_truth&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">&#39;Einstein was born in 1879 in Germany.&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;Einstein was born in 1879 in Germany.&#39;</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
dataset <span class="token operator">=</span> Dataset<span class="token punctuation">.</span>from_dict<span class="token punctuation">(</span>data_samples<span class="token punctuation">)</span>
score <span class="token operator">=</span> evaluate<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span>metrics<span class="token operator">=</span><span class="token punctuation">[</span>answer_correctness<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>
score<span class="token punctuation">.</span>to_pandas<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://raw.githubusercontent.com/levy9527/image-holder/main/md-image-kit/1711614954321-45e4ad75-2c87-42a9-9021-6455f01ec484.png" alt=""><br> 这是不能令人满意的——正确的回答，得到的指标分数却不足0.8。<br> 这是因为，正确性的评估，还依赖了相似度。<br><img src="https://raw.githubusercontent.com/levy9527/image-holder/main/md-image-kit/1711614692649-234f7b6a-16c5-4c09-95e7-db2877663e4c.png" alt=""></p><h2 id="忠实度✔" tabindex="-1"><a class="header-anchor" href="#忠实度✔" aria-hidden="true">#</a> 忠实度✔</h2><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv
load_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">from</span> datasets <span class="token keyword">import</span> Dataset
<span class="token keyword">from</span> ragas<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> faithfulness
<span class="token keyword">from</span> ragas <span class="token keyword">import</span> evaluate

data_samples <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&#39;question&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">&#39;When did Einstein born?&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;Where did Einstein born?&#39;</span><span class="token punctuation">,</span>
                 <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&#39;answer&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
               <span class="token string">&#39;Einstein was born in 1879.&#39;</span><span class="token punctuation">,</span>
               <span class="token string">&#39;Einstein was born in Germany.&#39;</span><span class="token punctuation">,</span>
               <span class="token comment">#&#39;Einstein was born in 1879 in Germany.&#39;</span>
               <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&#39;contexts&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span><span class="token string">&#39;Einstein was born in 1879 in Germany.&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">&#39;Einstein was born in 1879 in Germany.&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
dataset <span class="token operator">=</span> Dataset<span class="token punctuation">.</span>from_dict<span class="token punctuation">(</span>data_samples<span class="token punctuation">)</span>
score <span class="token operator">=</span> evaluate<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span>metrics<span class="token operator">=</span><span class="token punctuation">[</span>faithfulness<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>
score<span class="token punctuation">.</span>to_pandas<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://raw.githubusercontent.com/levy9527/image-holder/main/md-image-kit/1711614916136-dfc65b51-b0ec-41a6-8bae-d0907806fb49.png" alt=""><br> 符合预期，满足要求！</p><h2 id="实战演示" tabindex="-1"><a class="header-anchor" href="#实战演示" aria-hidden="true">#</a> 实战演示</h2><h3 id="准备好样例问题" tabindex="-1"><a class="header-anchor" href="#准备好样例问题" aria-hidden="true">#</a> 准备好样例问题</h3><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>sample_questions <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">&#39;一级地类中，面积哪个最大，哪个最小？&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;林地中最小的地类，与耕地中最大的地类面积相差多少？&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;建设用地总面积是多少？&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;2021年哪个月预审面积最大？&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;去年建设供地总面积，与前年比相差多少 &#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;过去几年用地审批面积趋势&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="准备好正确答案" tabindex="-1"><a class="header-anchor" href="#准备好正确答案" aria-hidden="true">#</a> 准备好正确答案</h3><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>ground_truths <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">&#39;一级地类中面积最大的是林地，面积为1609.53万公顷；面积最小的是湿地，面积为12.72万公顷。&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;林地中最小的地类是竹林地，面积为38.55万公顷。耕地中最大的地类是旱地，面积为167.17万公顷。它们的面积差距为167.17 - 38.55 = 128.62万公顷。&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;建设用地总面积为132.86万公顷。&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;2021年预审面积最大的月份是12月，预审面积为15875.50公顷&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;去年建设供地总面积为26,883.06公顷，前年建设供地总面积为29,670.19公顷。两年的差值为2,787.13公顷。&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;2021年的用地审批面积为57147.14公顷, 2022年的用地审批面积为50901.37公顷, 2023年的用地审批面积为17408.21公顷&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="编写回答函数" tabindex="-1"><a class="header-anchor" href="#编写回答函数" aria-hidden="true">#</a> 编写回答函数</h3><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_answer_from_ai</span><span class="token punctuation">(</span>question<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token comment"># 填充你的程序逻辑</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="进行答案评估" tabindex="-1"><a class="header-anchor" href="#进行答案评估" aria-hidden="true">#</a> 进行答案评估</h3><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">evaluation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  llm_answers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sample_questions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    llm_answers<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token keyword">await</span> get_answer_from_ai<span class="token punctuation">(</span>sample_questions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  data_samples <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&#39;question&#39;</span><span class="token punctuation">:</span> sample_questions<span class="token punctuation">,</span>
    <span class="token string">&#39;answer&#39;</span><span class="token punctuation">:</span> llm_answers<span class="token punctuation">,</span>
    <span class="token string">&#39;contexts&#39;</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span> ground_truths<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
  dataset <span class="token operator">=</span> Dataset<span class="token punctuation">.</span>from_dict<span class="token punctuation">(</span>data_samples<span class="token punctuation">)</span>
  score <span class="token operator">=</span> evaluate<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> metrics<span class="token operator">=</span><span class="token punctuation">[</span>faithfulness<span class="token punctuation">]</span><span class="token punctuation">)</span>
  result_df <span class="token operator">=</span> score<span class="token punctuation">.</span>to_pandas<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&#39;question&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;faithfulness&#39;</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
  result_table <span class="token operator">=</span> result_df<span class="token punctuation">.</span>values<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">print</span><span class="token punctuation">(</span>tabulate<span class="token punctuation">(</span>result_table<span class="token punctuation">,</span> headers<span class="token operator">=</span>result_df<span class="token punctuation">.</span>columns<span class="token punctuation">,</span> tablefmt<span class="token operator">=</span><span class="token string">&#39;simple&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Accuracy Rate: </span><span class="token interpolation"><span class="token punctuation">{</span>result_df<span class="token punctuation">[</span><span class="token string">&#39;faithfulness&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>eq<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token builtin">len</span><span class="token punctuation">(</span>sample_questions<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">}</span></span><span class="token string">%&quot;</span></span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
  asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>evaluation<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>效果如下：<br><img src="https://raw.githubusercontent.com/levy9527/image-holder/main/md-image-kit/1712136338962-974f31a0-1b27-404e-92de-b26dc6de8adb.png" alt=""></p>`,28),i=[p];function o(c,l){return s(),a("div",null,i)}const d=n(e,[["render",o],["__file","evaluate-llm-app-with-ragas.html.vue"]]);export{d as default};
